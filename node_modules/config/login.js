var crypto = require('crypto');
var rand = require('csprng');
var mongoose = require('mongoose');
var gravatar = require('gravatar');
var user = require('config/models');

/* Path: HOST/login
 *  Return: JSON Object that contains 'code' & 'msg'
 *  
 *  1 -> Successfully logged in
 * -1 -> Phone number not registered
 * -2 -> Incorrect Password
 * -7 -> Required field not set
 */

exports.login = function(sess,phone_number,password,callback) {
    
    if(phone_number.trim().length == 0 || password.trim().length == 0){
        callback({
            'code' : "-7",
            'msg':"Required field not set"
        });
    }

    user.find({phone_number: phone_number},function(err,users){

        if(users.length != 0){

            var temp = users[0].salt;
            var hash_db = users[0].hashed_password;
            var id = users[0].token;
            var newpass = temp + password;
            var hashed_password = crypto.createHash('sha512').update(newpass).digest("hex");

            if(hash_db == hashed_password){

                // update user_id in session
                sess.user_id = users[0]._id;

                callback({
                    'code' : "1",
                    'msg' : "Login Sucess"
                });
            }else{
                callback({
                    'code' : "-2",
                    'msg':"Incorrect Password"
                });
            }
        }else {
            callback({
                'code' : "-1",
                'msg':"Phone number not registered"
            });
        }
    });
} 