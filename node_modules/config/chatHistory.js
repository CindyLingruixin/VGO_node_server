var models = require('config/models');

exports.chatHistory = function(sess, other_user_id, number_of_message,callback) {

    var jsonAry = [];
    var your_user_id = sess.user_id;

    if(!your_user_id){
        jsonAry.push({code: "-1", msg: "Failed to authenticate, please login first", number_of_message: "0"});
        callback(jsonAry);
        return;

    }else if(!other_user_id || !number_of_message 
        || other_user_id.trim().length == 0 || number_of_message.trim().length == 0){
        jsonAry.push({code: "-2", msg: "Required field not set", number_of_message: "0"});
        callback(jsonAry);
        return;

    }else if(!((/^\d+$/).test(number_of_message) && number_of_message >= 1 && number_of_message <= 100)){
        jsonAry.push({code: "-3", msg: "Requested number of messages is invalid: must be an integer between 1 and 100", number_of_message: "0"});
        callback(jsonAry);
        return;

    }else{
        // check whether other_user_id is valid
        models.User.find({_id: other_user_id},function (err, users) {

            if (!users){
                jsonAry.push({code: "-4", msg: "Invalid other_user_id", number_of_message: "0"});
                callback(jsonAry);
                return;
            }else{
                models.ChatHistory.find({
                    $or : [
                        { $and : [ { sender_user_id : your_user_id }, { receiver_user_id : other_user_id } ] },
                        { $and : [ { sender_user_id : other_user_id }, { receiver_user_id : your_user_id } ] }
                    ]
                }, function (err2, records){

                    if(!records){
                        jsonAry.push({code: "-5", msg: "No record", number_of_message: "0"});
                        callback(jsonAry);
                        return;
                    }

                    // return the number of messages client askes for
                    var max_num;
                    if(records.length >= number_of_message){
                        max_num = number_of_message;
                    }else{
                        max_num = records.length;
                    }

                    jsonAry.push({code: "1", msg: "Seccess", number_of_message: ""+max_num});

                    for(var i=0; i<max_num; i++) {
                        var isYourMsg;
                        if(records[i].sender_user_id == your_user_id){
                            isYourMsg = "1";
                        }else{
                            isYourMsg = "0";
                        }
                        jsonAry.push({
                            is_your_message: isYourMsg,
                            date_time: (records[i]._id.getTimestamp().toDateString() +" "+ records[i]._id.getTimestamp().toTimeString()).substring(0,21),
                            message: records[i].message
                        });
                    }

                    // done! return jsonArray
                    callback(jsonAry);
                    return;
                }).sort({timestamp: 1});
            }
        });
    }
}